# Новая система ранжирования для поиска крепежа

## Обзор

Система ранжирования была полностью переписана для более точного отражения степени совпадения между поисковым запросом и найденными элементами каталога.

## Основные изменения

### 1. Новая система весов

| Критерий | Вес | Описание |
|----------|-----|----------|
| Стандарт DIN | 40% | Наибольший вклад за соответствие стандарту |
| Размеры | 30% | Точное совпадение диаметра и длины |
| Тип детали | 25% | Совпадение типа (болт, винт, гайка и т.д.) |
| Покрытие | 15% | Наименьший вклад за покрытие |

### 2. Бонусы за комбинации

- **Стандарт + Размеры**: +15% бонус
- **Тип + Размеры**: +10% бонус  
- **Полное совпадение** (тип + стандарт + размеры): +20% бонус

### 3. Ограничения вероятности

- **Стандарт + Размеры**: минимум 80%
- **Только тип** (без размеров и стандарта): максимум 40%
- **Только покрытие**: максимум 20%

## Функции

### `analyzeMatches(name, tokens)`

Анализирует совпадения между названием детали и поисковыми токенами.

**Возвращает:**
```typescript
{
  type_match: boolean,
  standard_match: boolean, 
  size_match: boolean,
  coating_match: boolean,
  matched_tokens: string[],
  explanation: string[]
}
```

### `calculateProbability(analysis)`

Вычисляет итоговую вероятность совпадения на основе анализа.

**Возвращает:**
```typescript
{
  probability: number, // 0-100%
  explanation: string  // Подробное объяснение
}
```

## Примеры работы

### Пример 1: Полное совпадение
**Запрос:** "Болт DIN 965 M8x20 оцинкованный"
**Результат:** ~100% (40% стандарт + 30% размеры + 25% тип + 15% покрытие + 20% бонус)

### Пример 2: Частичное совпадение
**Запрос:** "Винт M6x30"
**Результат:** ~65% (30% размеры + 25% тип + 10% бонус)

### Пример 3: Только тип
**Запрос:** "Гайка"
**Результат:** 25% (максимум 40% по ограничению)

## Новые поля в ответе

Каждый результат поиска теперь содержит:

- `probability_percent`: Новая вероятность совпадения (0-100%)
- `explanation`: Подробное объяснение расчета
- `matched_tokens`: Список найденных токенов
- `relevance_score`: Теперь равен `probability_percent`

## Логика расчета

1. **Базовые очки**: Суммируются веса за каждый тип совпадения
2. **Бонусы**: Добавляются за комбинации совпадений
3. **Ограничения**: Применяются минимальные/максимальные значения
4. **Нормализация**: Итоговый результат приводится к диапазону 0-100%

## Преимущества новой системы

- ✅ Более точное отражение релевантности
- ✅ Понятное объяснение результатов
- ✅ Логичные ограничения вероятности
- ✅ Учет комбинаций совпадений
- ✅ Приоритет важных критериев (стандарт, размеры)
